## Описание интеграции с AI провайдерами

Проект использует библиотеку `@ai-sdk` для интеграции с различными AI провайдерами. Файл `lib/models.ts` содержит функцию `getModelClient`, которая отвечает за создание клиентов для работы с этими провайдерами.

### Функция `getModelClient`

Функция `getModelClient` принимает два аргумента:

*   `model`: объект, содержащий информацию о модели, такую как:
    *   `id`: ID модели (например, "gpt-4").
    *   `name`: Имя модели (например, "GPT-4").
    *   `provider`: Название провайдера (например, "openai").
    *   `providerId`: ID провайдера (например, "openai").
*   `config`: объект, содержащий конфигурацию модели, такую как:
    *   `apiKey`: API ключ для доступа к API провайдера.
    *   `baseURL`: Базовый URL для доступа к API провайдера.
    *   `temperature`: Температура для генерации текста.
    *   `topP`: Top P для генерации текста.
    *   `topK`: Top K для генерации текста.
    *   `frequencyPenalty`: Frequency penalty для генерации текста.
    *   `presencePenalty`: Presence penalty для генерации текста.
    *   `maxTokens`: Максимальное количество токенов для генерации текста.

Внутри функции `getModelClient` определяется объект `providerConfigs`, который содержит функции для создания клиентов для различных AI провайдеров. Каждая функция принимает API ключ и базовый URL (если необходимо) и возвращает клиент для работы с API провайдера.

### Интеграция с различными AI провайдерами

Ниже описана интеграция с каждым AI провайдером:

*   **Anthropic:**
    *   Используется функция `createAnthropic` из `@ai-sdk/anthropic`.
    *   API ключ берется из переменной окружения `ANTHROPIC_API_KEY`.
    *   Базовый URL можно переопределить с помощью переменной `baseURL` в объекте `config`.
*   **OpenAI:**
    *   Используется функция `createOpenAI` из `@ai-sdk/openai`.
    *   API ключ берется из переменной окружения `OPENAI_API_KEY`.
    *   Базовый URL можно переопределить с помощью переменной `baseURL` в объекте `config`.
*   **Google AI:**
    *   Используется функция `createGoogleGenerativeAI` из `@ai-sdk/google`.
    *   API ключ берется из переменной окружения `GOOGLE_AI_API_KEY`.
    *   Базовый URL можно переопределить с помощью переменной `baseURL` в объекте `config`.
*   **Mistral:**
    *   Используется функция `createMistral` из `@ai-sdk/mistral`.
    *   API ключ берется из переменной окружения `MISTRAL_API_KEY`.
    *   Базовый URL можно переопределить с помощью переменной `baseURL` в объекте `config`.
*   **Groq:**
    *   Используется функция `createOpenAI` из `@ai-sdk/openai`.
    *   API ключ берется из переменной окружения `GROQ_API_KEY`.
    *   Базовый URL устанавливается в `https://api.groq.com/openai/v1`.
    *   Базовый URL нельзя переопределить с помощью переменной `baseURL` в объекте `config`.
*   **Fireworks:**
    *   Используется функция `createFireworks` из `@ai-sdk/fireworks`.
    *   API ключ берется из переменной окружения `FIREWORKS_API_KEY`.
    *   Базовый URL устанавливается в `https://api.fireworks.ai/inference/v1`.
    *   Базовый URL нельзя переопределить с помощью переменной `baseURL` в объекте `config`.
*   **Together AI:**
    *   Используется функция `createOpenAI` из `@ai-sdk/openai`.
    *   API ключ берется из переменной окружения `TOGETHER_API_KEY`.
    *   Базовый URL устанавливается в `https://api.together.xyz/v1`.
    *   Базовый URL нельзя переопределить с помощью переменной `baseURL` в объекте `config`.
*   **Ollama:**
    *   Используется функция `createOllama` из `ollama-ai-provider`.
    *   Базовый URL берется из переменной окружения `OLLAMA_BASE_URL`.
    *   API ключ не используется.
*   **Vertex:**
    *   Используется функция `createVertex` из `@ai-sdk/google-vertex`.
    *   Учетные данные берутся из переменной окружения `GOOGLE_VERTEX_CREDENTIALS`.
    *   API ключ не используется.
*   **XAI:**
    *   Используется функция `createOpenAI` из `@ai-sdk/openai`.
    *   API ключ берется из переменной окружения `XAI_API_KEY`.
    *   Базовый URL устанавливается в `https://api.x.ai/v1`.
    *   Базовый URL нельзя переопределить с помощью переменной `baseURL` в объекте `config`.
*   **Deepseek:**
    *   Используется функция `createOpenAI` из `@ai-sdk/openai`.
    *   API ключ берется из переменной окружения `DEEPSEEK_API_KEY`.
    *   Базовый URL устанавливается в `https://api.deepseek.com/v1`.
    *   Базовый URL нельзя переопределить с помощью переменной `baseURL` в объекте `config`.

### Добавление новой AI модели

Для добавления новой AI модели необходимо выполнить следующие шаги:

1.  Установить и настроить SDK для нового AI провайдера (если необходимо).
2.  Добавить новую запись в объект `providerConfigs` в файле `lib/models.ts`.
3.  В новой записи указать:
    *   ID провайдера.
    *   Функцию для создания клиента для нового AI провайдера.
    *   Переменную окружения для API ключа (если необходимо).
    *   Базовый URL (если необходимо).
4.  Добавить новую модель в файл `lib/models.json` (если необходимо).

### Рекомендации по исправлению ошибки парсинга JSON в Next.js

Ошибка `SyntaxError: Unexpected end of JSON input` возникает, когда:

1.  Сервер возвращает пустой ответ.
2.  Ответ содержит невалидный JSON.
3.  Происходит разрыв соединения.

Для исправления этой ошибки рекомендуется добавить следующие проверки:

1.  **Проверка пустого ответа:**

```javascript
const text = await response.text();
if (!text.trim()) {
  // Обработка пустого ответа
  return;
}
```

2.  **Безопасный парсинг:**

```javascript
try {
  const data = JSON.parse(text);
} catch (e) {
  console.error('Ошибка парсинга:', e);
}
```

3.  **Проверка статуса ответа:**

```javascript
if (!response.ok) {
  throw new Error(`HTTP error! status: ${response.status}`);
}
```

Рекомендуется добавить все три уровня проверок в компоненте, где возникает ошибка парсинга JSON.

### Шаблоны и данные для формирования запросов к ИИ

При формировании запроса к ИИ используются следующие шаблоны и данные:

1.  **Системный промпт:**
    *   Формируется в функции `toPrompt` в файле `lib/prompt.ts`.
    *   Содержит общие инструкции для ИИ, такие как:
        *   "You are a skilled software engineer."
        *   "You do not make mistakes."
        *   "Generate an fragment."
        *   "You can install additional dependencies."
        *   "Do not touch project dependencies files like package.json, package-lock.json, requirements.txt, etc."
        *   "Do not wrap code in backticks."
        *   "Always break the lines correctly."
    *   Также содержит информацию о доступных шаблонах, которая формируется с помощью функции `templatesToPrompt`.
2.  **Информация о доступных шаблонах:**
    *   Формируется в функции `templatesToPrompt` в файле `lib/templates.ts`.
    *   Содержит информацию о каждом шаблоне, такую как:
        *   ID шаблона.
        *   Инструкции для шаблона.
        *   Файл, связанный с шаблоном (если есть).
        *   Список зависимостей, установленных в шаблоне.
        *   Порт, используемый шаблоном (если есть).
3.  **Сообщения:**
    *   Массив сообщений, который передается в функцию `streamObject` в файле `app/api/chat/route.ts`.
    *   Содержит историю разговора и текущий запрос пользователя.